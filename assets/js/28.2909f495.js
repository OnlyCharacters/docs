(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{309:function(s,t,a){"use strict";a.r(t);var r=a(14),e=Object(r.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"stdiscosrv-docker"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#stdiscosrv-docker"}},[s._v("#")]),s._v(" Stdiscosrv docker")]),s._v(" "),t("h2",{attrs:{id:"stdiscosrv"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#stdiscosrv"}},[s._v("#")]),s._v(" "),t("a",{attrs:{href:"https://docs.syncthing.net/users/stdiscosrv.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Stdiscosrv"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("Github: "),t("a",{attrs:{href:"https://github.com/syncthing/discosrv/releases",target:"_blank",rel:"noopener noreferrer"}},[s._v("Releases · syncthing/discosrv · GitHub"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("关于证书，有三种方法处理：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("使用 CA 签名的证书和密钥")])]),s._v(" "),t("li",[t("p",[s._v("使用 stdiscosrv 自己生成的证书密钥，这个证书和密钥是通过 device ID 生成的")])]),s._v(" "),t("li",[t("p",[s._v("启动 stdicosrv 时添加 -http 参数，然后把 stdiscosrv 放在其他 https 反向代理后面")])])]),s._v(" "),t("p",[s._v("对于第一种，发现服务器可以直接填写")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("https://{域名}:{端口}/\n")])])]),t("p",[s._v("对于第二种，需要添加 device ID 作为参数")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("https://{域名 / IP}:{端口}/?id={stdiscosrv 生成的 device ID}\n")])])]),t("h2",{attrs:{id:"_1-dockerfile"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-dockerfile"}},[s._v("#")]),s._v(" 1. Dockerfile")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("From")]),s._v(" alpine")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /root")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ARG")]),s._v(" STDISCOSRV=v1.23.4")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VOLUME")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/stdiscosrv"')]),s._v("]")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" wget https://github.com/syncthing/discosrv/releases/download/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$STDISCOSRV")]),s._v("/stdiscosrv-linux-amd64-"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$STDISCOSRV")]),s._v(".tar.gz && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    tar xzvf stdiscosrv-linux-amd64-"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$STDISCOSRV")]),s._v(".tar.gz && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    mv stdiscosrv-linux-amd64-"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$STDISCOSRV")]),s._v("/stdiscosrv /usr/bin && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    rm -rf stdiscosrv-linux-amd64-"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$STDISCOSRV")]),s._v(".tar.gz stdiscosrv-linux-amd64-"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$STDISCOSRV")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENTRYPOINT")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("]")]),s._v("\n")])])]),t("h2",{attrs:{id:"_2-build"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-build"}},[s._v("#")]),s._v(" 2. Build")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" build "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" stdiscosrv "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--network")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v("\n")])])]),t("h2",{attrs:{id:"_3-running"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-running"}},[s._v("#")]),s._v(" 3. Running")]),s._v(" "),t("h3",{attrs:{id:"有域名证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#有域名证书"}},[s._v("#")]),s._v(" 有域名证书")]),s._v(" "),t("p",[s._v("请酌情替换下面参数")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--restart")]),s._v(" unless-stopped "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" /path/to/your/cert:/cert "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" /etc/stdiscosrv:/stdiscosrv "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--network")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" stdiscosrv "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\nireina/stdiscosrv "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\nstdiscosrv "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-cert")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/cert/fullchain.cer "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-key")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/cert/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("私钥文件名"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" -db-dir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/stdiscosrv\n")])])]),t("p",[s._v("更好的做法")]),s._v(" "),t("p",[s._v('"/path/to/your/cert" 一般指 acme.sh 存放证书和私钥的地址，我使用 "/root/.acme.sh/{域名}_ecc"，但这种方法 acme.sh 官方并不推荐，原因是这个 path 可能在某个版本更新后会变，建议使用 acme.sh install 命令安装证书，详见：'),t("a",{attrs:{href:"https://github.com/acmesh-official/acme.sh/wiki/%E8%AF%B4%E6%98%8E#3-copy%E5%AE%89%E8%A3%85-%E8%AF%81%E4%B9%A6",target:"_blank",rel:"noopener noreferrer"}},[s._v("acme.sh - 安装证书"),t("OutboundLink")],1)]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("acme.sh --install-cert "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("域名"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--key-file       /path/to/https-key.pem  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--fullchain-file /path/to/https-cert.pem "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--reloadcmd")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"docker restart stdiscosrv"')]),s._v("\n")])])]),t("h3",{attrs:{id:"无域名证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#无域名证书"}},[s._v("#")]),s._v(" 无域名证书")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--restart")]),s._v(" unless-stopped "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" /etc/stdiscosrv:/stdiscosrv "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--network")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" stdiscosrv "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\nstdiscosrv "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\nstdiscosrv "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-cert")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/cert/cert.pem "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-key")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/cert/key.pem -db-dir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/stdiscosrv\n")])])]),t("p",[s._v("运行后记录生成的 device ID，发现服务器")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("https://<IP or domain>:8443/?id=<device ID>\n")])])]),t("p",[s._v("使用快捷键 Ctrl + p, q 退出容器（一直按住 Ctrl，先按一下 p，松开 p，再按一下 q）")])])}),[],!1,null,null,null);t.default=e.exports}}]);